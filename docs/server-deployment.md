# Deploying SecuriWatch on a Server

This guide provides instructions for deploying SecuriWatch on a production server, emphasizing security and resource management.

## Prerequisites

- A Linux server (e.g., Debian, Ubuntu) with root/sudo access.
- Recommended Minimums: 2+ CPUs, 4GB+ RAM, 50GB+ Storage (on the target partition, e.g., `/home` or `/opt`).
- Docker Engine installed: [Install Docker Engine](https://docs.docker.com/engine/install/)
- Docker Compose V2 (Plugin) installed: `sudo apt install docker-compose-plugin`
- `curl`, `git`, `openssl` installed: `sudo apt install curl git openssl`

## Step 1: Install SecuriWatch

Choose an installation directory with sufficient disk space (e.g., `/opt/securiwatch` or `$HOME/securiwatch`). The installer defaults to `$HOME/securiwatch`.

```bash
# Install to $HOME/securiwatch
curl -sL https://raw.githubusercontent.com/christophernader/securiwatch/main/install.sh | bash

# OR Install to /opt/securiwatch (requires sudo for the curl | bash part)
# curl -sL https://raw.githubusercontent.com/christophernader/securiwatch/main/install.sh | sudo bash -s -- -d /opt/securiwatch
```

This script downloads SecuriWatch, sets permissions, and runs the initial setup (`./setup.sh`). Data volumes will be stored as bind mounts within the chosen installation directory (e.g., `$HOME/securiwatch/data`).

## Step 2: Configure SecuriWatch for Production

Navigate to the installation directory (e.g., `$HOME/securiwatch` or `/opt/securiwatch`):
```bash
cd $HOME/securiwatch  # Or /opt/securiwatch
```

1. **Customize Environment (`.env`)**:
   ```bash
   # .env should exist after install.sh runs
sudo nano .env
   ```
   - **Ports**: Change `HTTP_PORT` (default 8080) and `HTTPS_PORT` (default 8443) if they conflict with other services.
   - **Credentials**: Set a strong `WAZUH_API_PASSWORD`.
   - **Resource Limits**: Uncomment and adjust `*_CPU_LIMIT` and `*_MEM_LIMIT` variables based on your server's capacity. Monitor usage with `docker stats` after starting.
   - **Alerting**: Configure SMTP/Webhook settings if desired.

2. **Generate Production SSL Certificates**:
   - **Use Let's Encrypt (Recommended)**:
     ```bash
     # Stop NGINX temporarily if running
     sudo docker compose stop nginx
     
     # Install certbot
     sudo apt install -y certbot python3-certbot-nginx
     
     # Obtain certificate (use --nginx plugin if NGINX manages the domain)
     sudo certbot certonly --standalone -d your-domain.com --non-interactive --agree-tos -m your-email@example.com
     
     # Copy certificates
     sudo cp /etc/letsencrypt/live/your-domain.com/fullchain.pem config/nginx/ssl/securiwatch.crt
     sudo cp /etc/letsencrypt/live/your-domain.com/privkey.pem config/nginx/ssl/securiwatch.key
     
     # Set permissions
     sudo chmod 600 config/nginx/ssl/securiwatch.key
     # Nginx container runs as non-root, ensure it can read certs
     sudo chown $(id -u):$(id -g) config/nginx/ssl/securiwatch.crt # Adjust if running install as root
     sudo chown $(id -u):$(id -g) config/nginx/ssl/securiwatch.key # Adjust if running install as root
     ```
   - *Self-signed certs are generated by default via `generate-certs.sh` during setup, suitable for testing/internal use only.* 

3. **Set Strong Dashboard Credentials**:
   ```bash
   # Replace 'admin' and 'your-secure-password'
   sudo echo "admin:$(openssl passwd -apr1 your-secure-password)" > config/nginx/.htpasswd
   sudo chmod 600 config/nginx/.htpasswd
   ```

## Step 3: Start/Restart SecuriWatch

Apply configuration changes and start/restart services:
```bash
# Ensure you are in the installation directory
cd $HOME/securiwatch # Or /opt/securiwatch

sudo docker compose down # Stop if running
sudo docker compose up -d  # Start with new config
```

Verify services are running: `sudo docker compose ps`

## Step 4: Access Dashboard

Open `https://your-domain.com:PORT` or `https://your-server-ip:PORT` in your browser (using the `HTTPS_PORT` configured in `.env`, default 8443).

## Step 5: Secure Your Deployment

1. **Configure Regular Backups**:
   - Data is now stored in `./data` within your installation directory.
   - Back up the entire installation directory (`$HOME/securiwatch` or `/opt/securiwatch`).
   - **Important**: Stop containers writing to data directories before backup for consistency (Elasticsearch, Wazuh Manager, Filebeat).
   ```bash
   # Example Backup Script (backup.sh)
   sudo nano backup.sh
   ```
   ```bash
   #!/bin/bash
   BACKUP_DIR="/var/backups/securiwatch"
   DATE=$(date +%Y-%m-%d)
   SOURCE_DIR="$HOME/securiwatch" # Or /opt/securiwatch
   COMPOSE_FILE="$SOURCE_DIR/docker-compose.yml"
   
   echo "Starting SecuriWatch backup for $DATE..."
   mkdir -p "$BACKUP_DIR"
   
   echo "Stopping data-writing containers..."
   # Use docker compose command found by setup.sh or detect here
   DC_CMD="docker compose"
   if ! command -v docker compose &> /dev/null; then DC_CMD="docker-compose"; fi
   sudo $DC_CMD -f "$COMPOSE_FILE" stop elasticsearch wazuh-manager filebeat
   
   echo "Performing backup using rsync..."
   # Exclude logs or other non-essential files if needed
   sudo rsync -a --delete --exclude='*.log' "$SOURCE_DIR/" "$BACKUP_DIR/$DATE/"
   
   echo "Restarting containers..."
   sudo $DC_CMD -f "$COMPOSE_FILE" start elasticsearch wazuh-manager filebeat
   
   echo "Compressing backup..."
   sudo tar -czf "$BACKUP_DIR/securiwatch-backup-$DATE.tar.gz" -C "$BACKUP_DIR" "$DATE"
   
   echo "Cleaning up old backups (keeping last 7)..."
   sudo rm -rf "$BACKUP_DIR/$DATE" # Remove uncompressed dir
   ls -t "$BACKUP_DIR"/securiwatch-backup-*.tar.gz | tail -n +8 | xargs -r sudo rm --
   
   echo "Backup complete: $BACKUP_DIR/securiwatch-backup-$DATE.tar.gz"
   ```
   - Schedule it via cron: `sudo chmod +x backup.sh && (crontab -l ; echo "0 2 * * * /path/to/backup.sh") | sudo crontab -`

2. **Set up Docker Log Rotation**:
   - Configure the Docker daemon to rotate container logs.
   ```bash
   sudo nano /etc/docker/daemon.json
   ```
   ```json
   {
     "log-driver": "json-file",
     "log-opts": {
       "max-size": "10m",
       "max-file": "3"
     }
   }
   ```
   - Restart Docker: `sudo systemctl restart docker`

3. **Set up Health Monitoring**:
   ```bash
   # Add to crontab
   (crontab -l ; echo "*/15 * * * * cd $HOME/securiwatch && ./scripts/healthcheck.sh > healthcheck.log 2>&1") | crontab - 
   # Note: Runs as the user adding the crontab entry
   ```

## Step 6: Additional Security Measures

- **fail2ban**: Protect the NGINX basic auth. Adjust `logpath` in `/etc/fail2ban/jail.d/securiwatch.conf` to point to Docker's json logs (often `/var/lib/docker/containers/*/*-json.log`).
- **Server Monitoring**: Use tools like Prometheus/Grafana, Netdata, etc.
- **Firewall**: Ensure only necessary ports (`HTTPS_PORT`, `HTTP_PORT`, SSH) are open to the intended networks.

## Troubleshooting

*(Commands assume installation in `$HOME/securiwatch`, adjust path if needed)*

- **Check Logs**: `cd $HOME/securiwatch && sudo docker compose logs [service_name]`
- **Check Status**: `cd $HOME/securiwatch && sudo docker compose ps`
- **Resources**: Check `sudo docker stats`
- **Connectivity**: Verify firewall rules.

## Updating

```bash
cd $HOME/securiwatch # Or /opt/securiwatch
sudo ./update.sh
```

Monitor security advisories for components (Elasticsearch, Wazuh, NGINX). 